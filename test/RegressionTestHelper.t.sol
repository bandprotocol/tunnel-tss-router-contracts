// SPDX-License-Identifier: MIT

pragma solidity ^0.8.23;

import "forge-std/Test.sol";
import "forge-std/console.sol";

import "./helper/RegressionTestHelper.sol";

contract RelayGasMeasurementTest is Test {
    uint256[] points;

    function setUp() public {
        for (uint256 i = 0; i < 50; i++) {
            points.push(0);
        }
    }

    function test_det() public pure {
        assertEq(
            RegressionTestHelper.det4(
                RegressionTestHelper.Matrix4x4({
                    a11: 1,
                    a12: 0,
                    a13: 0,
                    a14: 0,
                    a21: 0,
                    a22: 1,
                    a23: 0,
                    a24: 0,
                    a31: 0,
                    a32: 0,
                    a33: 1,
                    a34: 0,
                    a41: 0,
                    a42: 0,
                    a43: 0,
                    a44: 1
                })
            ),
            int256(1)
        );
        assertEq(
            RegressionTestHelper.det4(
                RegressionTestHelper.Matrix4x4({
                    a11: 1,
                    a12: 1,
                    a13: 1,
                    a14: 1,
                    a21: 1,
                    a22: 1,
                    a23: 1,
                    a24: 1,
                    a31: 1,
                    a32: 1,
                    a33: 1,
                    a34: 1,
                    a41: 1,
                    a42: 1,
                    a43: 1,
                    a44: 1
                })
            ),
            int256(0)
        );
        assertEq(
            RegressionTestHelper.det4(
                RegressionTestHelper.Matrix4x4({
                    a11: 232,
                    a12: -23,
                    a13: -7775,
                    a14: 911,
                    a21: 923,
                    a22: 3032,
                    a23: 0,
                    a24: -1,
                    a31: 1,
                    a32: 3492,
                    a33: -4728,
                    a34: -1653,
                    a41: 5891,
                    a42: -8052,
                    a43: -9570,
                    a44: 100
                })
            ),
            int256(447638294209192)
        );
    }

    function testCoeffCalculation() public {
        RegressionTestHelper.Linear memory fx;
        RegressionTestHelper.Quadratic memory gx;
        RegressionTestHelper.Cubic memory hx;

        // case1 ---------------------------------------------------------------------------

        points[0] = ((0 << 128) + 98787);
        points[1] = ((1 << 128) + 99893);
        points[2] = ((2 << 128) + 100975);
        points[3] = ((3 << 128) + 102033);
        points[4] = ((4 << 128) + 103139);
        points[5] = ((5 << 128) + 104221);
        points[6] = ((6 << 128) + 105303);
        points[7] = ((7 << 128) + 106386);
        points[8] = ((8 << 128) + 107444);
        points[9] = ((9 << 128) + 108551);
        points[10] = ((10 << 128) + 109633);
        points[11] = ((11 << 128) + 110716);
        points[12] = ((12 << 128) + 111799);
        points[13] = ((13 << 128) + 112882);
        points[14] = ((14 << 128) + 113953);
        points[15] = ((15 << 128) + 115048);
        points[16] = ((16 << 128) + 116119);
        points[17] = ((17 << 128) + 117215);
        points[18] = ((18 << 128) + 118286);
        points[19] = ((19 << 128) + 119382);
        points[20] = ((20 << 128) + 120441);
        points[21] = ((21 << 128) + 121537);
        points[22] = ((22 << 128) + 122621);
        points[23] = ((23 << 128) + 123705);
        points[24] = ((24 << 128) + 124789);
        points[25] = ((25 << 128) + 125873);
        points[26] = ((26 << 128) + 126933);
        points[27] = ((27 << 128) + 128041);
        points[28] = ((28 << 128) + 129102);
        points[29] = ((29 << 128) + 130222);
        points[30] = ((30 << 128) + 131295);
        points[31] = ((31 << 128) + 132380);
        points[32] = ((32 << 128) + 133452);
        points[33] = ((33 << 128) + 134525);
        points[34] = ((34 << 128) + 135634);
        points[35] = ((35 << 128) + 136719);
        points[36] = ((36 << 128) + 137780);
        points[37] = ((37 << 128) + 138878);
        points[38] = ((38 << 128) + 139963);
        points[39] = ((39 << 128) + 141061);
        points[40] = ((40 << 128) + 142158);
        points[41] = ((41 << 128) + 143244);
        points[42] = ((42 << 128) + 144294);
        points[43] = ((43 << 128) + 145416);
        points[44] = ((44 << 128) + 146490);
        points[45] = ((45 << 128) + 147564);
        points[46] = ((46 << 128) + 148638);
        points[47] = ((47 << 128) + 149748);
        points[48] = ((48 << 128) + 150822);
        points[49] = ((49 << 128) + 151909);

        // Results from np.polyfit
        //
        // --- Optimal Linear ---
        // a (slope): 1083.747370948379
        // b (y-intercept): 98788.16941176468
        // ------------------------------

        // --- Optimal Quadratic ---
        // a (x^2 term): 0.04896227721860076
        // b (x term):   1081.348219364669
        // c (constant): 98807.36262443438
        // ------------------------------

        // --- Optimal Cubic ---
        // a (x^3 term): 0.000940915846927263
        // b (x^2 term): -0.020195037530464532
        // c (x term):   1082.6900594539666
        // d (constant): 98802.16199436528
        // ------------------------------

        fx = RegressionTestHelper.linear(points);
        assertEq(fx.c1, 1083747370948379351740);
        assertEq(fx.c0, 98788169411764705882352);

        gx = RegressionTestHelper.quadratic(points);
        assertEq(gx.c2, 48962277218579739);
        assertEq(gx.c1, 1081348219364668944500);
        assertEq(gx.c0, 98807362624434389140271);

        hx = RegressionTestHelper.cubic(points);
        assertEq(hx.c3, 940915846930440);
        assertEq(hx.c2, -20195037530807647);
        assertEq(hx.c1, 1082690059453976445903);
        assertEq(hx.c0, 98802161994365235208742);

        // case2 ---------------------------------------------------------------------------

        points[0] = (0 << 128) + 38079;
        points[1] = (1 << 128) + 38977;
        points[2] = (2 << 128) + 39881;
        points[3] = (3 << 128) + 40789;
        points[4] = (4 << 128) + 41705;
        points[5] = (5 << 128) + 42630;
        points[6] = (6 << 128) + 43565;
        points[7] = (7 << 128) + 44444;
        points[8] = (8 << 128) + 45473;
        points[9] = (9 << 128) + 46448;
        points[10] = (10 << 128) + 47440;
        points[11] = (11 << 128) + 48451;
        points[12] = (12 << 128) + 49482;
        points[13] = (13 << 128) + 50535;
        points[14] = (14 << 128) + 51526;
        points[15] = (15 << 128) + 52625;
        points[16] = (16 << 128) + 53849;
        points[17] = (17 << 128) + 55013;
        points[18] = (18 << 128) + 56208;
        points[19] = (19 << 128) + 57439;
        points[20] = (20 << 128) + 58708;
        points[21] = (21 << 128) + 60016;
        points[22] = (22 << 128) + 61368;
        points[23] = (23 << 128) + 62763;
        points[24] = (24 << 128) + 64206;
        points[25] = (25 << 128) + 65700;
        points[26] = (26 << 128) + 67245;
        points[27] = (27 << 128) + 68847;
        points[28] = (28 << 128) + 70508;
        points[29] = (29 << 128) + 72229;
        points[30] = (30 << 128) + 73826;
        points[31] = (31 << 128) + 75671;
        points[32] = (32 << 128) + 77794;
        points[33] = (33 << 128) + 79792;
        points[34] = (34 << 128) + 81868;
        points[35] = (35 << 128) + 84022;
        points[36] = (36 << 128) + 86261;
        points[37] = (37 << 128) + 88588;
        points[38] = (38 << 128) + 91004;
        points[39] = (39 << 128) + 93515;
        points[40] = (40 << 128) + 96123;
        points[41] = (41 << 128) + 98832;
        points[42] = (42 << 128) + 101647;
        points[43] = (43 << 128) + 104571;
        points[44] = (44 << 128) + 107608;
        points[45] = (45 << 128) + 110760;
        points[46] = (46 << 128) + 113633;
        points[47] = (47 << 128) + 117014;
        points[48] = (48 << 128) + 120956;
        points[49] = (49 << 128) + 124617;

        // Results from np.polyfit
        //
        // --- Optimal Linear ---
        // a (slope): 1661.8547418967582
        // b (y-intercept): 29769.57882352938
        // ------------------------------

        // --- Optimal Quadratic ---
        // a (x^2 term): 27.07018653615293
        // b (x term):   335.41560162526537
        // c (constant): 40381.09194570137
        // ------------------------------

        // --- Optimal Cubic ---
        // a (x^3 term): 0.4482223701944078
        // b (x^2 term): -5.874157673136074
        // c (x term):   974.6255237595111
        // d (constant): 37903.67726116282
        // ------------------------------

        fx = RegressionTestHelper.linear(points);
        assertEq(fx.c1, 1661854741896758703481);
        assertEq(fx.c0, 29769578823529411764705);

        gx = RegressionTestHelper.quadratic(points);
        assertEq(gx.c2, 27070186536152922707);
        assertEq(gx.c1, 335415601625265490811);
        assertEq(gx.c0, 40381091945701357466063);

        hx = RegressionTestHelper.cubic(points);
        assertEq(hx.c3, 448222370194410716);
        assertEq(hx.c2, -5874157673136264974);
        assertEq(hx.c1, 974625523759514613985);
        assertEq(hx.c0, 37903677261162810552377);

        // case3 ---------------------------------------------------------------------------

        for (uint256 i = 0; i < 30; i++) {
            points.push(0);
        }

        points[0] = (1700 << 128) + 120207;
        points[1] = (1764 << 128) + 121303;
        points[2] = (1828 << 128) + 122387;
        points[3] = (1892 << 128) + 123471;
        points[4] = (1956 << 128) + 124531;
        points[5] = (2020 << 128) + 125639;
        points[6] = (2084 << 128) + 126711;
        points[7] = (2148 << 128) + 127796;
        points[8] = (2212 << 128) + 128892;
        points[9] = (2276 << 128) + 129965;
        points[10] = (2340 << 128) + 131062;
        points[11] = (2404 << 128) + 132134;
        points[12] = (2468 << 128) + 133207;
        points[13] = (2532 << 128) + 134316;
        points[14] = (2596 << 128) + 135389;
        points[15] = (2660 << 128) + 136462;
        points[16] = (2724 << 128) + 137536;
        points[17] = (2788 << 128) + 138645;
        points[18] = (2852 << 128) + 139707;
        points[19] = (2916 << 128) + 140828;
        points[20] = (2980 << 128) + 141902;
        points[21] = (3044 << 128) + 142976;
        points[22] = (3108 << 128) + 144062;
        points[23] = (3172 << 128) + 145148;
        points[24] = (3236 << 128) + 146234;
        points[25] = (3300 << 128) + 147344;
        points[26] = (3364 << 128) + 148418;
        points[27] = (3428 << 128) + 149504;
        points[28] = (3492 << 128) + 150567;
        points[29] = (3556 << 128) + 151665;
        points[30] = (3620 << 128) + 152764;
        points[31] = (3684 << 128) + 153827;
        points[32] = (3748 << 128) + 154926;
        points[33] = (3812 << 128) + 156037;
        points[34] = (3876 << 128) + 157112;
        points[35] = (3940 << 128) + 158211;
        points[36] = (4004 << 128) + 159286;
        points[37] = (4068 << 128) + 160373;
        points[38] = (4132 << 128) + 161473;
        points[39] = (4196 << 128) + 162536;
        points[40] = (4260 << 128) + 163552;
        points[41] = (4324 << 128) + 164700;
        points[42] = (4388 << 128) + 165800;
        points[43] = (4452 << 128) + 166899;
        points[44] = (4516 << 128) + 167963;
        points[45] = (4580 << 128) + 169064;
        points[46] = (4644 << 128) + 170164;
        points[47] = (4708 << 128) + 171252;
        points[48] = (4772 << 128) + 172353;
        points[49] = (4836 << 128) + 173417;
        points[50] = (4900 << 128) + 174518;
        points[51] = (4964 << 128) + 175618;
        points[52] = (5028 << 128) + 176671;
        points[53] = (5092 << 128) + 177700;
        points[54] = (5156 << 128) + 178849;
        points[55] = (5220 << 128) + 179926;
        points[56] = (5284 << 128) + 181051;
        points[57] = (5348 << 128) + 182093;
        points[58] = (5412 << 128) + 183242;
        points[59] = (5476 << 128) + 184295;
        points[60] = (5540 << 128) + 185421;
        points[61] = (5604 << 128) + 186475;
        points[62] = (5668 << 128) + 187565;
        points[63] = (5732 << 128) + 188678;
        points[64] = (5796 << 128) + 189756;
        points[65] = (5860 << 128) + 190870;
        points[66] = (5924 << 128) + 191913;
        points[67] = (5988 << 128) + 193051;
        points[68] = (6052 << 128) + 194117;
        points[69] = (6116 << 128) + 195220;
        points[70] = (6180 << 128) + 196322;
        points[71] = (6244 << 128) + 197377;
        points[72] = (6308 << 128) + 198456;
        points[73] = (6372 << 128) + 199571;
        points[74] = (6436 << 128) + 200662;
        points[75] = (6500 << 128) + 201777;
        points[76] = (6564 << 128) + 202868;
        points[77] = (6628 << 128) + 203923;
        points[78] = (6692 << 128) + 204978;
        points[79] = (6756 << 128) + 206118;

        // Results from np.polyfit
        // --- Optimal Linear ---
        // y = a*x + b    | a≈16.990460545593063  b≈91274.30781323243

        // --- Optimal Quadratic ---
        // y = a*x^2+bx+c | a≈1.3213146669124686e-05 b≈16.878730177358975 c≈91481.64576242982

        // --- Optimal Cubic ---
        // y = ax^3+bx^2+cx+d | a≈-2.6976128549173684e-10 b≈1.6634798814289008e-05 c≈16.865323789895797 d≈91497.55103595725

        fx = RegressionTestHelper.linear(points);
        assertEq(fx.c1, 16990460545593061415);
        assertEq(fx.c0, 91274307813232536333802);

        gx = RegressionTestHelper.quadratic(points);
        assertEq(gx.c2, 13213146669125);
        assertEq(gx.c1, 16878730177358934667);
        assertEq(gx.c0, 91481645762429949323328);

        hx = RegressionTestHelper.cubic(points);
        assertEq(hx.c3, -269761285);
        assertEq(hx.c2, 16634798814257);
        assertEq(hx.c1, 16865323789895885217);
        assertEq(hx.c0, 91497551035957099317890);
    }
}
